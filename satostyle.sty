\ProvidesPackage{satostyle}

% ****************************************************************************************************
% 0. Prerequisites
% ****************************************************************************************************
\usepackage{etoolbox} % For \AtEndPreamble
\newif\ifdraft % Define the switch here, set it in config.tex


% ****************************************************************************************************
% 1. Packages
% ****************************************************************************************************
\usepackage{iftex}
\usepackage{graphicx}
\usepackage{amsmath, amssymb, amsthm}
\usepackage{caption}
\usepackage{url}
\usepackage{csquotes}
\usepackage{enumitem}
% Set description label spacing to 1 Japanese character width
\newlength{\desclabelsep}
\setlength{\desclabelsep}{1\zw}
\setlist[description]{labelsep=\desclabelsep}
\usepackage{booktabs}
\usepackage{multirow}
\usepackage{tabularx} % better tables
  \setlength{\extrarowheight}{3pt} % increase table row height
\usepackage[printonlyused]{acronym}
\usepackage{subfig}
\usepackage{threeparttable}
\usepackage{siunitx}
\usepackage{rotating}
\usepackage{xurl}
\usepackage{tcolorbox}
\usepackage{multicol}
\usepackage{titletoc} % Custom Table of Contents
\usepackage{colortbl}       
\usepackage{array}         
\usepackage{twemojis}
\usepackage{marginnote}
% FORCE the margin width manually. 
% jlreq sets this to 0 by default, so we must override it.
% Your outer margin is 40mm, so let's use 30mm for the note (leaving 10mm buffer).
\setlength{\marginparwidth}{30mm} 
\setlength{\marginparsep}{5mm}    % Space between text and note

\usepackage{luacolor} % Required for lua-ul
\usepackage{lua-ul}
\usepackage{fancybox}

% 2. Load todonotes with your specific settings
\usepackage[
    textwidth=30mm,         % Fit inside the 32mm margin
    textsize=footnotesize,  % Set font to small
    color=orange!50,        % Post-it Yellow (50% yellow, 50% white)
    shadow,                 % Enable shadows
    loadshadowlibrary       % <--- FIXES YOUR WARNING
]{todonotes}

% 1. Create a counter for the side notes
\newcounter{mysidenote}
\counterwithin*{mysidenote}{chapter}
% 2. Define the command \mynote{Your Note Text}
\newcommand{\mynote}[1]{%
  \refstepcounter{mysidenote}%            % Step the counter (1, 2, 3...)
  \textsuperscript{\themysidenote}%       % Put the number in the main text
  \marginnote{%
    \footnotesize%                      % Use smaller font for the note
    \textsuperscript{\themysidenote}%     % Put the number in the margin
    #1%                                 % The actual note text
  }%
}


\usepackage{tikz}
\usepackage[pass]{geometry}
% Japanese date formatting
\usepackage[useregional=false]{datetime2}
\DTMnewdatestyle{japanese}{%
  \renewcommand*\DTMdisplaydate[4]{%
    ##1年##2月%
  }%
  \renewcommand*\DTMDisplaydate{\DTMdisplaydate}%
}
\DTMsetdatestyle{japanese}

\usepackage{fancyhdr}
\setlength{\headheight}{15.142pt} % Fix fancyhdr warning

% Fix for missing commands/counters
\newcounter{dummy}
\newcommand{\spacedlowsmallcaps}[1]{\textbf{#1}}

% --- ClassicThesis "Hanging Number" Style ---
% Use Noto Serif (\rmfamily) or your preferred font
\newcommand{\headfont}{\small\rmfamily}

% --- Clean Chapter/Section Names ---
\renewcommand{\chaptermark}[1]{\markboth{\thechapter.\ #1}{}}
\renewcommand{\sectionmark}[1]{\markright{\thesection.\ #1}}

% ****************************************************************************************************
% 2. Font Setup (Noto)
% ****************************************************************************************************
\usepackage[no-math]{fontspec}
\usepackage{luatexja-fontspec}
\usepackage{xcolor}
% Define the classic thesis color (CTsemi) - usually a dark gray
\definecolor{CTsemi}{gray}{0.3} 
\definecolor{CTcitation}{rgb}{0,0.5,0} % WebGreen
\definecolor{CTurl}{cmyk}{1.0, 0.82, 0.08, 0.16} % Maroon
\definecolor{CTtitle}{cmyk}{1.0, 0.82, 0.08, 0.16} % Maroon {cmyk}{0, 0.87, 0.68, 0.32}
\definecolor{CTlink}{cmyk}{1, 0.50, 0, 0}
\definecolor{halfgray}{gray}{0.55} % chapter numbers will be semi transparent .5 .55 .6 .0
\definecolor{webgreen}{rgb}{0,0.5,0}
\definecolor{webbrown}{rgb}{0.6,0,0}


% Define Palatino specifically for the Number
% (TeX Gyre Pagella is the standard open-source Palatino)
\newfontfamily\PalatinoNum{TeX Gyre Pagella}[UprightFont=*-Bold, BoldFont=*-Bold] 

% (Ensure you have your HeadSerif defined from the previous step)
% If not, uncomment this:
\newfontfamily\HeadLatinSerif{Noto Serif CJK JP}[UprightFont=*-Medium, BoldFont=*-Bold]
\newjfontfamily\HeadCJKSerif{Noto Serif CJK JP}[UprightFont=*-Medium, BoldFont=*-Bold]
\newcommand{\HeadSerif}{\HeadLatinSerif\HeadCJKSerif}




% English (Latin)
\setmainfont{Noto Serif}[
  UprightFont = *-Light,
  ItalicFont  = *-Light Italic,
  BoldFont    = *-Medium
]
\setsansfont{Noto Sans}[
  UprightFont = *-Light,
  ItalicFont  = *-Light Italic,
  BoldFont    = *-Medium
]
\setmonofont{Noto Sans Mono}[
  UprightFont = *-Light,
  BoldFont    = *-Medium
]

% Japanese (CJK)
\setmainjfont[
  BoldFont={Noto Serif CJK JP Bold},
  ItalicFont={Noto Serif CJK JP}
]{Noto Serif CJK JP}
\setsansjfont[
  BoldFont={Noto Sans CJK JP Bold}
]{Noto Sans CJK JP}
\setmonojfont{Noto Sans Mono CJK JP}

% 1. Simplified Chinese (简体中文)
\newjfontfamily\zhscfont{Noto Serif CJK SC}
\newcommand{\textzhsc}[1]{{\zhscfont #1}} % Command: \textzh{...}

% 2. Traditional Chinese (繁體中文)
\newjfontfamily\zhtcfont{Noto Serif CJK TC}
\newcommand{\textzhtc}[1]{{\zhtcfont #1}} % Command: \textzhtc{...}

% 3. Korean (한국어)
\newjfontfamily\krfont{Noto Serif CJK KR}
\newcommand{\textkr}[1]{{\krfont #1}}   % Command: \textko{...}

\newfontfamily\thaifont{Noto Serif Thai}[Script=Thai]

\newcommand{\textthai}[1]{{\thaifont #1}}


% ****************************************************************************************************
% 3. BibLaTeX Configuration (Japanese Support)
% ****************************************************************************************************
\usepackage[
  backend=biber,
  bibencoding=utf8,
  language=auto,
  style=apa,
  sorting=nyt,
  maxbibnames=20,
  giveninits=false
]{biblatex}

\setlength{\bibhang}{2em}
\appto{\bibsetup}{\setlength{\emergencystretch}{3em}}

\DeclareLanguageMapping{american}{american-apa}
\DeclareLanguageMapping{english}{english-apa}
\DeclareLanguageMapping{japanese}{english-apa}

% Custom sorting: use yomi field for Japanese entries
\DeclareSourcemap{
  \maps[datatype=bibtex]{
    \map[overwrite]{
      \step[fieldsource=langid, match=japanese, final]
      \step[fieldsource=yomi, fieldset=sortname, origfieldval]
    }
    \map[overwrite]{
      \step[typesource=incollectionja, typetarget=incollection, final]
      \step[fieldset=keywords, fieldvalue=incollectionja, append]
      \step[fieldset=langid, fieldvalue=japanese]
    }
  }
}

% Japanese bibliography formatting
\DefineBibliographyStrings{japanese}{
  in      = {},
  editor  = {編},
  editors = {編},
}

% Override "In" macro
\renewbibmacro*{in}{%
  \ifboolexpr{
    test {\iffieldequalstr{langid}{japanese}}
    or
    test {\ifkeyword{incollectionja}}
  }
    {}
    {%
      \ifbool{bbx:in}%
        {}%
        {\global\booltrue{bbx:in}%
         \printtext{\bibstring{in}\addspace}}%
    }%
}

% Override editor string macro
\renewbibmacro*{apaeditorstrg}[1]{%
  \ifboolexpr{
    test {\iffieldequalstr{langid}{japanese}}
    or
    test {\ifkeyword{incollectionja}}
  }
    {編}
    {\iffieldundef{#1type}
       {\ifthenelse{\value{#1}>1\OR\ifandothers{#1}}
          {\bibcpstring{editors}}
          {\bibcpstring{editor}}}
       {\ifthenelse{\value{#1}>1\OR\ifandothers{#1}}
            {\bibcpstring{type\thefield{#1type}s}}
            {\bibcpstring{type\thefield{#1type}}}}}%
}

% Override the low-level name format used by APA
\DeclareNameFormat{apaauthor}{%
  \iffieldequalstr{langid}{japanese}
    {% Japanese: Family + Given
      \namepartfamily
      \namepartgiven
      \ifnumequal{\value{listcount}}{\value{liststop}}
        {}
        {・}%
    }
    {% Non-Japanese: standard APA format
      \ifcase\value{uniquename}%
        \usebibmacro{name:family-given}
          {\namepartfamily}
          {\namepartgiveni}
          {\namepartprefix}
          {\namepartsuffix}%
      \or
        \ifuseprefix
          {\usebibmacro{name:given-family}
            {\namepartfamily}
            {\namepartgiveni}
            {\namepartprefix}
            {\namepartsuffix}}
          {\usebibmacro{name:given-family}
            {\namepartfamily}
            {\namepartgiveni}
            {\namepartprefix}
            {\namepartsuffix}}%
      \or
        \usebibmacro{name:family-given}
          {\namepartfamily}
          {\namepartgiveni}
          {\namepartprefix}
          {\namepartsuffix}%
      \fi
    }%
  \usebibmacro{name:andothers}%
}

\DeclareNameFormat{apaeditor}{%
  \iffieldequalstr{langid}{japanese}
    {% Japanese: Family + Given
      \namepartfamily
      \namepartgiven
      \ifnumequal{\value{listcount}}{\value{liststop}}
        {}
        {・}%
    }
    {% Non-Japanese: Given Family
      \ifcase\value{uniquename}%
        \usebibmacro{name:given-family}
          {\namepartfamily}
          {\namepartgiveni}
          {\namepartprefix}
          {\namepartsuffix}%
      \or
        \ifuseprefix
          {\usebibmacro{name:given-family}
            {\namepartfamily}
            {\namepartgiveni}
            {\namepartprefix}
            {\namepartsuffix}}
          {\usebibmacro{name:given-family}
            {\namepartfamily}
            {\namepartgiveni}
            {\namepartprefix}
            {\namepartsuffix}}%
      \or
        \usebibmacro{name:given-family}
          {\namepartfamily}
          {\namepartgiveni}
          {\namepartprefix}
          {\namepartsuffix}%
      \fi
    }%
  \usebibmacro{name:andothers}%
}
\DeclareNameAlias{apatranslator}{apaauthor}
\DeclareNameAlias{apanames}{apaauthor}

\DeclareNameFormat{labelname}{%
  \iffieldequalstr{langid}{japanese}
    {% Japanese: Family only for citations
      \namepartfamily
      \ifnumequal{\value{listcount}}{\value{liststop}}
        {}
        {・}%
    }
    {% Non-Japanese: standard APA
      \ifcase\value{uniquename}%
        \usebibmacro{name:family}
          {\namepartfamily}
          {\namepartgiven}
          {\namepartprefix}
          {\namepartsuffix}%
      \or
        \ifuseprefix
          {\usebibmacro{name:given-family}
            {\namepartfamily}
            {\namepartgiveni}
            {\namepartprefix}
            {\namepartsuffixi}}
          {\usebibmacro{name:given-family}
            {\namepartfamily}
            {\namepartgiveni}
            {\namepartprefix}
            {\namepartsuffixi}}%
      \or
        \usebibmacro{name:given-family}
          {\namepartfamily}
          {\namepartgiven}
          {\namepartprefix}
          {\namepartsuffix}%
      \fi
    }%
  \usebibmacro{name:andothers}%
}

\DeclareDelimFormat{multinamedelim}{%
  \iffieldequalstr{langid}{japanese}
    {・}%
    {\addcomma\space}%
}

\DeclareDelimFormat{finalnamedelim}{%
  \iffieldequalstr{langid}{japanese}
    {・}%
    {\space\&\space}%
}

\renewbibmacro*{name:andothers}{%
  \ifboolexpr{
    test {\ifnumequal{\value{listcount}}{\value{liststop}}}
    and
    test \ifmorenames
  }
    {%
      \iffieldequalstr{langid}{japanese}
        {他}%
        {\printdelim{andothersdelim}\bibstring{andothers}}%
    }
    {}%
}

\DeclareFieldFormat[article,inbook,incollection,inproceedings]{title}{#1}
\DeclareFieldFormat[book,report,thesis,unpublished]{title}{%
  \iffieldequalstr{langid}{japanese}
    {#1}%
    {\mkbibemph{#1}}%
}
\DeclareFieldFormat[article,book,inbook,incollection,inproceedings,report,thesis,unpublished]{journaltitle}{%
  \iffieldequalstr{langid}{japanese}
    {#1}%
    {\mkbibemph{#1}}%
}
\DeclareFieldFormat[article,book,inbook,incollection,inproceedings,report,thesis,unpublished]{booktitle}{%
  \iffieldequalstr{langid}{japanese}
    {#1}%
    {\mkbibemph{#1}}%
}

\addbibresource{Bibliography.bib}
\addbibresource{part1.bib}
\addbibresource{part2.bib}
%%%%%
\newcommand{\autorefja}[1]{%
  \begingroup
  \crefname{chapter}{第}{第}%
  \crefformat{chapter}{##2第##1章##3}%
  \crefname{section}{第}{第}%
  \crefformat{section}{##2第##1節##3}%
  \crefname{subsection}{第}{第}%
  \crefformat{subsection}{##2第##1項##3}%
  \crefname{figure}{図}{図}%
  \crefformat{figure}{##2図##1##3}%
  \crefname{table}{表}{表}%
  \crefformat{table}{##2表##1##3}%
  \crefname{appendix}{付録}{付録}%
  \crefformat{appendix}{##2付録##1##3}%
  \crefname{equation}{式}{式}%
  \crefformat{equation}{##2式##1##3}%
  \cref{#1}%
  \endgroup
}

% ****************************************************************************************************
% 5. Document Body Setup (Hyperref, Listings, Captions, Layout)
% ****************************************************************************************************
\usepackage{hyperref}
\usepackage{cleveref}
\usepackage{listings}

\lstset{
    basicstyle=\ttfamily\footnotesize,
    breaklines=true,
    frame=single,
    columns=fullflexible,
    keepspaces=true,
    showstringspaces=false
}

\definecolor{headerblue}{RGB}{52, 73, 94}
\definecolor{lightgray}{RGB}{245, 245, 245}

% --- Caption TEXT Font (Light) ---
\newfontfamily\CapLatinText{Noto Sans}[UprightFont=*-Light]         % English
\newjfontfamily\CapJpText{Noto Sans CJK JP}[UprightFont=*-Light]    % Japanese
\DeclareCaptionFont{mycaptext}{\CapLatinText\CapJpText}             % Combine them

% --- Caption LABEL Font (Medium) ---
\newfontfamily\CapLatinLabel{Noto Sans}[UprightFont=*-Medium]       % English
\newjfontfamily\CapJpLabel{Noto Sans CJK JP}[UprightFont=*-Medium]  % Japanese
\DeclareCaptionFont{mycaplabel}{\CapLatinLabel\CapJpLabel}          % Combine them

% 2. Apply these specific fonts to the caption settings
\captionsetup{
    font=mycaptext,       % Use the Custom Light font for the text
    labelfont=mycaplabel, % Use the Custom Medium font for the label (Fig 1)
    labelsep=quad         % Space between label and text
}

% --- Part Page Customization ---
% Mechanism to store and print part text (quote)
\newcommand{\ctparttextcontent}{}
\newcommand{\ctparttext}[1]{\renewcommand{\ctparttextcontent}{#1}}
\newcommand{\printparttext}{%
  \ifx\ctparttextcontent\empty\else
    \bigskip
    \parbox{0.8\textwidth}{%
      \normalfont\normalsize\color{black}%
      \ctparttextcontent
    }%
    \renewcommand{\ctparttextcontent}{}% Clear after use
  \fi
}

\makeatletter
% Save and restore page style around part pages
\let\@oldpart\part
\renewcommand\part{%
  \cleardoublepage % Force Odd Page
  \thispagestyle{empty}%
  \null\vfil
  \secdef\@part\@spart}

\def\@part[#1]#2{%
    \ifnum \c@secnumdepth >-2\relax
      \refstepcounter{part}%
      \addcontentsline{toc}{part}{\protect\numberline{\thepart}#1}%
    \else
      \addcontentsline{toc}{part}{#1}%
    \fi
    \markboth{}{}%
    {\centering
     \interlinepenalty \@M
     \normalfont\Large\HeadSerif\bfseries
     \ifnum \c@secnumdepth >-2\relax
       第\thepart 部
       \par\vspace{1em}
     \fi
     {\color{CTtitle}\Huge #2\par}
     \vspace{1.6em}
     \printparttext
     \par}%
    \vfil\newpage
    \if@mainmatter\pagestyle{fancy}\fi% Restore fancy style in mainmatter
}

\def\@spart#1{%
    {\centering
     \interlinepenalty \@M
     \normalfont\Large\HeadSerif\bfseries
     {\color{CTtitle}\Huge #1\par}
     \printparttext
     \par}%
    \vfil\newpage
    \if@mainmatter\pagestyle{fancy}\fi% Restore fancy style in mainmatter
}
\makeatother

% Redefine chapter command (full control like \@part)
\makeatletter
\renewcommand\chapter{\clearpage\global\@topnum\z@\@afterindentfalse\secdef\@chapter\@schapter}

\def\@chapter[#1]#2{%
    \ifnum \c@secnumdepth >\m@ne
      \refstepcounter{chapter}%
      \addcontentsline{toc}{chapter}{\protect\numberline{\thechapter}#1}%
    \else
      \addcontentsline{toc}{chapter}{#1}%
    \fi
    \chaptermark{#1}%
    \thispagestyle{plain}% Apply plain style to THIS chapter page
    \@makechapterhead{#2}%
    \@afterheading
}

\def\@schapter#1{%
    \thispagestyle{plain}% Apply plain style to THIS chapter page
    \@makeschapterhead{#1}%
    \@afterheading
}

% Chapter heading layout (numbered)
\def\@makechapterhead#1{%
    \vspace*{10mm}%
    \noindent
    %\hspace*{-0.2cm}%
    \parbox{\textwidth}{%
      \setlength{\parindent}{0pt}%
      \raggedright
      % --- Numbered Chapter ---
      % --- Custom Label ---
      {\HeadSerif\mdseries\Large 第}\,%
      {%
        \color{CTtitle}%
        \PalatinoNum\mdseries\Huge\selectfont
        \raisebox{-0.2ex}{\thechapter}%
      }%
      \,{\HeadSerif\mdseries\Large 章}%
      \par
      \vspace{0.5\baselineskip}
      % --- Title ---
      {\HeadSerif\mdseries\huge #1}
      \par
      \vspace{0.8\baselineskip}
      % --- Line ---
      \hrule height 0.4pt depth 0pt width \textwidth
    }%
    \vspace{10mm}%
}

% Chapter heading layout (unnumbered)
\def\@makeschapterhead#1{%
    \vspace*{10mm}%
    \noindent
    %\hspace*{-0.2cm}%
    \parbox{\textwidth}{%
      \setlength{\parindent}{0pt}%
      \raggedright
      {\HeadSerif\mdseries\huge #1}
      \par
      \vspace{0.8\baselineskip}
      \hrule height 0.4pt depth 0pt width \textwidth
    }%
    \vspace{10mm}%
}
\makeatother

% Sans Medium (For Sections)
\newfontfamily\HeadLatinSans{Noto Sans CJK JP}[UprightFont=*-Medium, BoldFont=*-Bold]
\newjfontfamily\HeadCJKSans{Noto Sans CJK JP}[UprightFont=*-Medium, BoldFont=*-Bold]
\newcommand{\HeadSans}{\HeadLatinSans\HeadCJKSans}

% Sans Regular (For ToC)
\newfontfamily\HeadLatinSansRegular{Noto Sans CJK JP}[UprightFont=*-Regular, BoldFont=*-Medium]
\newjfontfamily\HeadCJKSansRegular{Noto Sans CJK JP}[UprightFont=*-Regular, BoldFont=*-Medium]
\newcommand{\HeadSansRegular}{\HeadLatinSansRegular\HeadCJKSansRegular}

% Sans Light (For ToC)
\newfontfamily\HeadLatinSansLight{Noto Sans CJK JP}[UprightFont=*-Light, BoldFont=*-Medium]
\newjfontfamily\HeadCJKSansLight{Noto Sans CJK JP}[UprightFont=*-Light, BoldFont=*-Medium]
\newcommand{\HeadSansLight}{\HeadLatinSansLight\HeadCJKSansLight}

% etoolbox for future use
%\usepackage{etoolbox} % Already loaded at top

\ModifyHeading{section}{font={\HeadSans\mdseries\large}}
\ModifyHeading{subsection}{font={\HeadSans\mdseries\normalsize}}
\ModifyHeading{subsubsection}{font={\HeadSans\mdseries\normalsize}}
\ModifyHeading{paragraph}{font={\HeadSans\mdseries\normalsize}}
\ModifyHeading{subparagraph}{font={\HeadSans\mdseries\normalsize}}

% ****************************************************************************************************
% 6. ToC Customization (titletoc)
% ****************************************************************************************************


% Redefine LoF and LoT to use custom chapter style without forced page break
\makeatletter
\renewcommand{\listoffigures}{%
  \begingroup
  \let\clearpage\relax
  \let\cleardoublepage\relax
  \@schapter{\listfigurename}%
  \@starttoc{lof}%
  \endgroup
}
\renewcommand{\listoftables}{%
  \begingroup
  \let\clearpage\relax
  \let\cleardoublepage\relax
  \@schapter{\listtablename}%
  \@starttoc{lot}%
  \endgroup
}
\makeatother

% Appendix ToC Configuration
\makeatletter
\appto\appendix{%
  \titlecontents{chapter}[0pt]{\addvspace{1pc}\HeadSerif\bfseries\large}
  {\thecontentslabel\quad}
  {}
  {\quad\contentspage}
  
  % Redefine chapter header for Appendix
  \def\@makechapterhead#1{%
      \vspace*{10mm}%
      \noindent
      %\hspace*{-0.2cm}%
      \parbox{\textwidth}{%
        \setlength{\parindent}{0pt}%
        \raggedright
        % --- Numbered Chapter ---
        % --- Custom Label ---
        {\HeadSerif\mdseries\Large 付録}\,%
        {%
          \color{CTtitle}%
          \PalatinoNum\mdseries\Huge\selectfont
          \raisebox{-0.2ex}{\thechapter}%
        }%
        % \,{\HeadSerif\mdseries\Large 章}% Removed for Appendix
        \par
        \vspace{0.5\baselineskip}
        % --- Title ---
        {\HeadSerif\mdseries\huge #1}
        \par
        \vspace{0.8\baselineskip}
        % --- Line ---
        \hrule height 0.4pt depth 0pt width \textwidth
      }%
      \vspace{10mm}%
  }
}
\makeatother

% ****************************************************************************************************
% Defer setup that depends on config.tex
% ****************************************************************************************************
\AtEndPreamble{
  % --- Define FANCY page style (for content pages with headers) ---
  \fancypagestyle{fancy}{%
    \fancyhf{} % Clear all fields first
    \renewcommand{\headrulewidth}{0pt} % No line
    % Even Pages (Left): [Number hanging left] [Chapter Title]
    \fancyhead[LE]{\headfont \llap{\thepage\kern2em}\nouppercase{\leftmark}}
    % Odd Pages (Right): [Section Title] [Number hanging right]
    \fancyhead[RO]{\headfont \nouppercase{\rightmark}\rlap{\kern2em\thepage}}
    % Draft mode footer: show version and date at bottom center
    \ifdraft
      \fancyfoot[C]{\footnotesize\color{CTtitle}\textbf{\myVersion\ -- \myDraftDate}}
    \fi
  }

  % --- Define PLAIN page style (for chapter first pages) ---
  \fancypagestyle{plain}{%
    \fancyhf{} % Clear all header and footer fields
    \renewcommand{\headrulewidth}{0pt}
    \renewcommand{\footrulewidth}{0pt}
    % Page numbers at bottom outer corners (inside text block)
    \fancyfoot[LE,RO]{\headfont\thepage}
    % Draft mode footer: show version and date at bottom center
    \ifdraft
      \fancyfoot[C]{\footnotesize\color{CTtitle}\textbf{\myVersion\ -- \myDraftDate}}
    \fi
  }

  % --- Hyperref Setup ---
  \hypersetup{%
    %draft, % hyperref's draft mode, for printing see below
    colorlinks=true, linktocpage=true, pdfstartpage=3, pdfstartview=FitV,%
    % uncomment the following line if you want to have black links (e.g., for printing)
    %colorlinks=false, linktocpage=false, pdfstartpage=3, pdfstartview=FitV, pdfborder={0 0 0},%
    breaklinks=true, pageanchor=true,%
    pdfpagemode=UseNone, %
    % pdfpagemode=UseOutlines,%
    plainpages=false, bookmarksnumbered, bookmarksopen=true, bookmarksopenlevel=1,%
    hypertexnames=true, pdfhighlight=/O,%nesting=true,%frenchlinks,%
    urlcolor=CTurl, linkcolor=CTlink, citecolor=CTcitation, %pagecolor=RoyalBlue,%
    %urlcolor=Black, linkcolor=Black, citecolor=Black, %pagecolor=Black,%
    pdftitle={\myTitle},%
    pdfauthor={\textcopyright\ \myName, \myUni, \myFaculty},%
    pdfsubject={},%
    pdfkeywords={},%
    pdfcreator={LuaLaTeX},%
    pdfproducer={LaTeX with hyperref and jlreq}%
  }

  % ****************************************************************************************************
  % 6. ToC Customization (titletoc)
  % ****************************************************************************************************
  % Part
  \titlecontents{part}[0pt]{\addvspace{2pc}\color{CTtitle}\HeadSerif\bfseries\large}
  {\thecontentslabel\quad}
  {}
  {}

  % Chapter
  \titlecontents{chapter}[0pt]{\addvspace{1pc}\HeadSerif\bfseries\large}
  {%
    {第}\,%
    {%
      \color{CTtitle}\PalatinoNum\LARGE
      \raisebox{-0.1ex}{\thecontentslabel}%
    }%
    \,{章}%
    \newline
  }
  {}
  {\quad\contentspage}

  % Section
  \titlecontents{section}[3em]{\addvspace{2pt}\HeadSansRegular}
  {\hspace*{-3em}\makebox[3em][l]{\thecontentslabel}}
  {}
  {\quad\contentspage}

  % Subsection
  \titlecontents{subsection}[6.5em]{\addvspace{1pt}\HeadSansRegular}
  {\hspace*{-3.5em}\makebox[3.5em][l]{\thecontentslabel}}
  {}
  {\quad\contentspage}

  % Subsubsection
  \titlecontents{subsubsection}[10.5em]{\HeadSansRegular}
  {\hspace*{-4em}\makebox[4em][l]{\thecontentslabel}}
  {}
  {\quad\contentspage}

  % Figure
  \titlecontents{figure}[4.5em]{\addvspace{1pt}\HeadSansLight}
  {\hspace*{-4.5em}{\HeadSans\makebox[4.5em][l]{図\thecontentslabel}}}
  {}
  {\quad\contentspage}

  % Table
  \titlecontents{table}[4.5em]{\addvspace{1pt}\HeadSansLight}
  {\hspace*{-4.5em}{\HeadSans\makebox[4.5em][l]{表\thecontentslabel}}}
  {}
  {\quad\contentspage}
}
